<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ergon Ext</title>
    <style>
        body {
            font-family: Consolas, 'Courier New', monospace;
            font-size: 14px;
        }
        #cabeçalho {
            position: fixed;
            z-index: 5;
            top: 0;
            right: 0;
            left: 0;
            margin: 0;
            padding: 0;
            background: rgb(30, 30, 30);
        }
        #cabeçalho form {
            padding: 1em;
            padding-bottom: 0.5em;
        }
        #cabeçalho form div span {
            white-space: nowrap;
            padding: 4px 0 4px 0;
            display: inline-block;
            width: 130px;
            text-align: right;
            font-size: 11px;
        }
        button:focus { outline: 0; }
        #cabeçalho button {
            float: right;
            margin-top: 0.3em;
            margin-right: 0.5em;
            margin-left: 0.5em;
            background-color: rgb(14, 99, 156);
            border: none;
            color: white;
            padding: 4px 10px 4px 10px;
        }
        #cabeçalho button:hover {
            background-color: rgb(17, 119, 187);
        }
        .inputTitulo {
            display: inline-block;
            width: 5em;
            text-align: right;
        }
        input {
            width: 4em;
            margin-left: 1em;
            padding: 4px 6px 4px 6px;
            background-color: rgb(60, 60, 60);
            color: rgba(255, 255, 255, 0.788);
            border: none;
        }
        input:focus {
            outline: 1;
            outline-color: rgb(23, 74, 108);
        }
        select {
            width: 5em;
            margin-left: 1em;
            padding: 4px 6px 4px 6px;
            background-color: rgb(60, 60, 60);
            color: rgba(255, 255, 255, 0.788);
            border: none;
        }
        select:focus {
            outline: 1;
            outline-color: rgb(23, 74, 108);
        }
        .titulos {
            padding: 0.25em;
            background-color: rgb(9, 71, 113);
        }
        .titulosI {
            float: left;
            width: calc(100% - 48px);
        }
        /* header campo */
        .hc {
            display: inline-block;
            width: 4.45em;
            color: white;
            text-align: center;

            margin-left: 1em;
            padding-left: 1em;
            border-left-style: solid;
            border-left-width: 2px;
            border-left-color: rgba(255, 255, 255, 0.160);
        }
        /* borda direita (right) */
        .rBorder {
            padding-right: 1em;
            border-right-style: solid;
            border-right-width: 2px;
            border-right-color: rgba(255, 255, 255, 0.160);
        }
        pre {
            margin-top: 110px;
            font-family: Consolas, 'Courier New', monospace;
            color:  rgba(255, 255, 255, 0.603);
            font-size: 14px;
        }
        #conteudoArquivo:focus { outline: 0; }
        .caminho {
            float: left;
            width: 96%;
            margin: 1em;
            padding: 8px;
            text-align: center;
            white-space: normal;
            border-style: solid;
            border-width: 1px;
            border-color: rgba(255, 255, 255, 0.160);
            background: rgb(50, 50, 50);
        }
        /* header linha */
        .lin {
            float: left;
            width: 100%;
            white-space: nowrap;
        }
        .rubEntra {
            position: relative;
            display: inline-block;
            width: calc(100% - 48px);
            background-color: rgba(0, 192, 48, 0.137);
            color:  rgb(255, 255, 255);
        }
        .rubSai {
            position: relative;
            display: inline-block;
            width: calc(100% - 48px);
            background-color: rgba(192, 48, 0, 0.137);
            color:  rgb(255, 255, 255);
        }
        .rubEntra .rubInfo, .rubSai .rubInfo {
            visibility: hidden;
            padding: 5px 8px 5px 0px;
            margin-bottom: 1px;
            border-style: solid;
            border-width: 1px;
            border-color: rgba(255, 255, 255, 0.160);
            background: rgb(50, 50, 50);

            bottom: 100%;
 
            /* Position the tooltip text - see examples below! */
            position: absolute;
            z-index: 6;
        }
        /* Show the tooltip text when you mouse over the tooltip container */
        .rubEntra:hover .rubInfo, .rubSai:hover .rubInfo {
            visibility: visible;
        }
        .texto {
            margin-left: 3em;
        }
        /** campo */
        .c {
            margin-left: 1em;
            padding-left: 1em;
            border-left-style: solid;
            border-left-width: 2px;
            border-left-color: rgba(255, 255, 255, 0.005);
        }
        /** campo sem borda */
        .csb {
            color: rgba(255, 255, 255, 0.452);
            border-left-style: none;
            margin: 0;
            padding: 0 1em 0 1em;
        }
        .nomeRubrica {
            display: inline-block;
            width: 26em;
        }
        .resultadoRub {
            display: inline-block;
            width: 5em;
            text-align: right;
        }
        .periodo {
            display: inline-block;
            width: 8em;
            text-align: right;
        }
        .contLinha {
            float: left;
            width: 32px;
            margin-right: 1em;
            color: rgba(255, 255, 255, 0.349);
            text-align: right;

            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #msgAoCarregar {
            position: fixed;
            bottom: 0;
            width: 10%;
            left: 50%;
            margin: 1em;
            margin-left: -5%;
            padding: 8px;
            text-align: center;
            border-style: solid;
            border-width: 1px;
            border-color: rgba(255, 255, 255, 0.160);
            background: rgb(50, 50, 50);
            visibility: hidden;
        }
        .autocomplete {
            /*the container must be positioned relative:*/
            position: relative;
            display: inline-block;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid rgb(23, 74, 108);
            text-align: left;
            z-index: 99;
            /*position the autocomplete items to be the same width as the container:*/
            top: 100%;
            left: 0;
            right: 0;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: rgb(60, 60, 60);
            /*border-bottom: 1px solid rgb(23, 74, 108);*/
        }
        .autocomplete-items div:hover {
            /*when hovering an item:*/
            background-color: rgb(42, 45, 46);
        }
        .autocomplete-active {
            /*when navigating through the items using the arrow keys:*/
            background-color: rgb(7, 54, 85) !important; 
            color: #ffffff; 
        }
    </style>
</head>
<body>
    <div>
        <div id="cabeçalho">
            <form id="campos" autocomplete="off">
                <div>
                    <div class="autocomplete"><span>Ambiente<input id="ambiente"/></span></div>
                    <div class="autocomplete"><span>ServCalc<input id="servidorCalculo"/></span></div>
                    <div class="autocomplete"><span>TipoCalc<input id="tipoCalculo"/></span></div>
                    <div class="autocomplete"><span>DataFol<input id="mesAnoFol"/></span></div>
                    <div class="autocomplete"><span>NumFol<input id="numFol"/></span></div>
                    <div class="autocomplete"><span>Exec<input id="execucao"/></span></div>
                    <div class="autocomplete"><span>Func<input id="numFunc"/></span></div>
                    <div class="autocomplete"><span>Vinc<input id="numVinc"/></span></div>
                    <div class="autocomplete"><span>SeqFunc<input id="seqFunc"/></span></div>
                    <div class="autocomplete"><span>SeqVinc<input id="seqVinc"/></span></div>
                    <div class="autocomplete"><span>DataRub<input id="mesAnoRub"/></span></div>
                    <span>Rub<input id="rubrica"/></span>
                    <span>Cpl<input id="complemento"/></span>
                    <span>Per<input id="periodo"/></span>
                    <span>E/S
                        <select id="tipo">
                            <option value="RE">E &gt;&gt;</option>
                            <option value="RS">S &lt;&lt;</option>
                        </select>
                    </span>
                    <span>Arquivo
                        <select id="acao">
                            <option value="abrirRubPer">Per</option>
                            <option value="abrirRubLiq">Liq</option>
                            <option value="abrirLogErro">Err</option>
                            <option value="abrirDump">Dump</option>
                        </select>
                    </span>
                    <button id="abrirIr" type="submit">Abrir / Ir</button>
                </div>
            </form>
            <div class="lin titulos">
                <span class="contLinha">&nbsp;</span>
                <span class="titulosI">
                    <span class="hc" style="width: 27.7em; border-style: none;">Rubrica</span>
                    <span class="hc" style="width: 7.4em;">Periodo</span>
                    <span class="hc">Val Calc</span>
                    <span class="hc">Val Pag</span>
                    <span class="hc">Val Liq</span>
                    <span class="hc">Mov Calc</span>
                    <span class="hc">Mov Pag</span>
                    <span class="hc rBorder">Mov Liq</span>
                </span>
            </div>
        </div>
        <pre id="conteudoArquivo" tabindex="50">Nada para exibir</pre>
        <div id="msgAoCarregar">Carregando...</div>
    </div>
    <script>
        window.vscode = acquireVsCodeApi();
        window.indice = {};
        window.indiceLinha = {};
        window.forcarRecarregar = false;
        window.autoCompletar = null;
        window.autoCompletarLista = [];
        window.camposAutoCompletar = ['ambiente', 'servidorCalculo', 'tipoCalculo', 'mesAnoFol', 'numFol',
            'execucao', 'numFunc', 'numVinc', 'seqFunc', 'seqVinc', 'mesAnoRub'];

        function pad(num, padlen) {
            var pad = new Array(1 + padlen).join('0');
            return (pad + num).slice(-pad.length);
        }
        
        function textoParaData(texto) {
            let arr = texto.trim().split('/');
            return { mes: parseInt(arr[0]), ano: parseInt(arr[1]) };
        }

        function dataParaTexto(data) {
            return pad(data.mes, 2) + '/' + pad(data.ano, 4)
        }

        function getCampos() {
            let campos = {
                ambiente        : document.getElementById('ambiente').value,
                servidorCalculo : document.getElementById('servidorCalculo').value,
                tipoCalculo     : document.getElementById('tipoCalculo').value,
                mesAnoFol       : textoParaData(document.getElementById('mesAnoFol').value),
                numFol          : document.getElementById('numFol').value,
                execucao        : document.getElementById('execucao').value,
                numFunc         : document.getElementById('numFunc').value,
                numVinc         : document.getElementById('numVinc').value,
                seqFunc         : document.getElementById('seqFunc').value,
                seqVinc         : document.getElementById('seqVinc').value,
                mesAnoRub       : textoParaData(document.getElementById('mesAnoRub').value),
                rubrica         : document.getElementById('rubrica').value,
                complemento     : document.getElementById('complemento').value,
                periodo         : document.getElementById('periodo').value,
                tipo            : document.getElementById('tipo').value,
                acao            : document.getElementById('acao').value
            };
            return campos;
        }

        window.addEventListener('message', event => {

            let m = event.data;
            document.getElementById('msgAoCarregar').style.visibility='hidden';

            switch(m.acao) {
                case 'parse_rubrica_ok':

                    // Quando não é nulo o arquivo mudou, então precisa alterar o conteudo
                    // da página e voltar a barra de rolagem pro começo
                    if(m.conteudo.texto !== null) {
                        document.getElementById('conteudoArquivo').innerHTML =
                                '<div class="caminho">' + m.conteudo.caminho.replace(/\//g, '\\') + '</div>' + m.conteudo.texto;
                        window.indice = m.conteudo.index;
                        window.indiceLinha = m.conteudo.indexLinha;
                        window.scrollTo(0, 0);
                    }

                    // Indo para o perido/rubrica selecionados
                    const rubrica = document.getElementById('rubrica').value;
                    const perido = document.getElementById('periodo').value;
                    const tipo = document.getElementById('tipo').value;

                    const linhaId = 'linha_' + window.indice[tipo + '_' + perido + '_' + rubrica];
                    document.getElementById(linhaId).scrollIntoView();
                    window.scrollBy(0, -document.getElementById('cabeçalho').offsetHeight);
                    document.getElementById('conteudoArquivo').focus();

                    break;
                case 'parse_rubrica_err':
                    document.getElementById('conteudoArquivo').innerHTML = m.conteudo; 
                    break;
                case 'filtro':
                    document.getElementById('ambiente').value        = m.conteudo.ambiente;
                    document.getElementById('servidorCalculo').value = m.conteudo.servidorCalculo;
                    document.getElementById('tipoCalculo').value     = m.conteudo.tipoCalculo;
                    document.getElementById('mesAnoFol').value       = dataParaTexto(m.conteudo.mesAnoFol);
                    document.getElementById('numFol').value          = m.conteudo.numFol;
                    document.getElementById('execucao').value        = m.conteudo.execucao;
                    document.getElementById('numFunc').value         = m.conteudo.numFunc;
                    document.getElementById('numVinc').value         = m.conteudo.numVinc;
                    document.getElementById('seqFunc').value         = m.conteudo.seqFunc;
                    document.getElementById('seqVinc').value         = m.conteudo.seqVinc;
                    document.getElementById('mesAnoRub').value       = dataParaTexto(m.conteudo.mesAnoRub);
                    document.getElementById('rubrica').value         = m.conteudo.rubrica;
                    document.getElementById('complemento').value     = m.conteudo.complemento;
                    document.getElementById('periodo').value         = m.conteudo.periodo;
                    document.getElementById('tipo').value            = m.conteudo.tipo;
                    document.getElementById('acao').value            = m.conteudo.acao;
                    break;
                case 'auto_completar':
                    window.autoCompletar = m.conteudo;
                    break;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('rubrica').focus();
        }, false);

        document.getElementById('abrirIr').addEventListener('click', function() {

            document.getElementById('msgAoCarregar').style.visibility='visible';

            let acao = document.getElementById('acao').value;
            let campos = getCampos();
            let forcar = window.forcarRecarregar;

            window.vscode.postMessage({
                acao: acao,
                filtro: campos,
                // Forçar recarregamento do arquivo
                forcar: forcar
            });

            window.forcarRecarregar = false;
        });

        document.getElementById('campos').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                document.getElementById('abrirIr').click();
            }
        });

        function getProximoHeader(idAtual) {
            let linhaAtual = parseInt(idAtual.split('_')[1]);

            // Converter para busca binária
            for(var i = 0; i < window.indiceLinha.length; i++) {
                if(window.indiceLinha[i].linha > linhaAtual) {
                    return window.indiceLinha[i];
                }
            }
            return null;
        }

        function getHeaderAnterior(idAtual) {
            let linhaAtual = parseInt(idAtual.split('_')[1]);

            // Converter para busca binária
            for(var i = window.indiceLinha.length -1; i >= 0; i--) {
                if(window.indiceLinha[i].linha < linhaAtual) {
                    return window.indiceLinha[i];
                }
            }
            return null;
        }

        function focoNoCampo(idCampo, e) {

            document.getElementById(idCampo).focus();
            document.getElementById(idCampo).select();

            // Bloqueando o evento padrão para a tecla atalho pressionada não ser inserida no campo
            if (e.preventDefault) e.preventDefault();
            e.returnValue = false;
            return false;
        }

        document.getElementById('conteudoArquivo').addEventListener('keypress', function(e) {
            
            let elementos = document.querySelectorAll( ":hover" );
            let id = elementos[4].childNodes[0].id;
            
            if(e.key === '.') {
                console.log('===');
                console.log(document.elementFromPoint(50, document.getElementById('cabeçalho').offsetHeight + 1));
                console.log(document.elementFromPoint(50, document.getElementById('cabeçalho').offsetHeight + 1).parentElement.parentElement);
                console.log(document.elementFromPoint(50, document.getElementById('cabeçalho').offsetHeight + 1).parentElement);

                let proximoHeader = getProximoHeader(id);
                // Se existe um próximo hader scroll até ele
                if(proximoHeader) {
                    const linhaId = 'linha_' + proximoHeader.linha;
                    document.getElementById(linhaId).scrollIntoView();
                    window.scrollBy(0, -document.getElementById('cabeçalho').offsetHeight);
                }
            }
            else if(e.key === ',') {
                let headerAnterior = getHeaderAnterior(id);
                // Se existe um próximo hader scroll até ele
                if(headerAnterior) {
                    const linhaId = 'linha_' + headerAnterior.linha;
                    document.getElementById(linhaId).scrollIntoView();
                    window.scrollBy(0, -document.getElementById('cabeçalho').offsetHeight);
                }
            }
            else if(e.key === 'a') return focoNoCampo('ambiente', e);
            else if(e.key === 'f') return focoNoCampo('numFunc', e);
            else if(e.key === 'v') return focoNoCampo('numVinc', e);
            else if(e.key === 'd') return focoNoCampo('mesAnoRub', e);
            else if(e.key === 'r') return focoNoCampo('rubrica', e);
            else if(e.key === 'p') return focoNoCampo('periodo', e);
            else if(e.key === 'e' || e.key === 's') {
                if(e.key === 'e') document.getElementById('tipo').value = 'RE';
                else document.getElementById('tipo').value = 'RS';
                focoNoCampo('tipo', e);
            }
            else if(e.key === 'c') {
                window.forcarRecarregar = true;
                document.getElementById('abrirIr').click();
            }
            
            return true;
        });

        function listaAutoCompletarRec(inputId, noArvore, arr) {

            // Se é um dos campos buscados, adiciona no array
            if(noArvore.campo == inputId) {
                arr.push(noArvore.valor);
            }
            // Se não é, mas é um campo pai e o valor bate com o que está no filtro, chama recursivo
            // para aprofundar um nível
            else if (noArvore.campo === 'raiz' || noArvore.valor === document.getElementById(noArvore.campo).value) {
                for (var i = 0; i < noArvore.filhos.length; i++) {
                    listaAutoCompletarRec(inputId, noArvore.filhos[i], arr);
                }
            }
        }
        
        function listaAutoCompletar(inputId) {

            if(window.autoCompletar == null) {
                return [];
            }
            var arr = [];
            listaAutoCompletarRec(inputId, window.autoCompletar, arr);
            return arr;
        }

        function autocomplete(inp) {

            /*the autocomplete function takes two arguments,
            the text field element and an array of possible autocompleted values:*/
            var currentFocus;

            /*execute a function when someone writes in the text field:*/
            inp.addEventListener("input", function(e) {

                var arr = window.autoCompletarLista;
                var a, b, i, val = this.value;
                /*close any already open lists of autocompleted values*/
                closeAllLists();
                // if (!val) { return false; }
                currentFocus = -1;
                /*create a DIV element that will contain the items (values):*/
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                /*append the DIV element as a child of the autocomplete container:*/
                this.parentNode.appendChild(a);
                /*for each item in the array...*/
                for(var i = 0; i < arr.length; i++) {
                    /*check if the item starts with the same letters as the text field value:*/
                    if (val == '' || arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        /*create a DIV element for each matching element:*/
                        b = document.createElement("DIV");
                        /*make the matching letters bold:*/
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        /*insert a input field that will hold the current array item's value:*/
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        /*execute a function when someone clicks on the item value (DIV element):*/
                        b.addEventListener("click", function(e) {
                            /*insert the value for the autocomplete text field:*/
                            inp.value = this.getElementsByTagName("input")[0].value;
                            /*close the list of autocompleted values,
                            (or any other open lists of autocompleted values:*/
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });

            // Gera a lista e força um evento para abrir a lista de auto complete ao receber foco.
            inp.addEventListener("focus", function(e) {
                window.autoCompletarLista = listaAutoCompletar(this.id);
                
                // Invertendo a lista se for os campos de data para ficar o mais recente primeiro
                if(['mesAnoFol', 'mesAnoRub'].includes(this.id)) {
                    window.autoCompletarLista = window.autoCompletarLista.reverse();
                }

                inp.dispatchEvent(new Event('input'));
            });

            /*execute a function presses a key on the keyboard:*/
            inp.addEventListener("keydown", function(e) {

                if(window.autoCompletarLista == null || window.autoCompletarLista.length < 1) return;

                var x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    /*If the arrow DOWN key is pressed,
                    increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 38) { //up
                    /*If the arrow UP key is pressed,
                    decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                } else if (e.keyCode == 13) {
                  
                    if (currentFocus > -1) {
                        /*If the ENTER key is pressed, prevent the form from being submitted,*/
                        e.preventDefault();
                        /*and simulate a click on the "active" item:*/
                        if (x) {
                            x[currentFocus].click();
                            currentFocus = -1;
                        }
                    }
                }
            });
            function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                if(x && x[currentFocus]) {
                    x[currentFocus].classList.add("autocomplete-active");
                }
            }
            function removeActive(x) {

                if(!x) return false;

                /*a function to remove the "active" class from all autocomplete items:*/
                for (var i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }
            function closeAllLists(elmnt) {

                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/

                var x = document.getElementsByClassName("autocomplete-items");

                for(var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            /*execute a function when someone clicks in the document:*/
            document.addEventListener("click", function (e) {
                if(e.target instanceof HTMLInputElement) {
                    if(e.target.id && window.camposAutoCompletar.includes(e.target.id)) {
                        return false;
                    }
                }
                closeAllLists(e.target);
            });
        }

        function adicionarAutoComplete() {
            for(var i = 0; i < window.camposAutoCompletar.length; i++) {
                autocomplete(document.getElementById(window.camposAutoCompletar[i]));
            }
        }

        adicionarAutoComplete();
    </script>
</body>
</html>